name: åŒæ­¥è¯­é›€ç¬”è®°

on:
  schedule:
    # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
    - cron: '0 2 1 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºåˆ†æ”¯å’Œæ¨é€ä»£ç 
      pull-requests: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º PR
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
    
      - name: é…ç½® Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
    
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
    
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆPuppeteer æ‰€éœ€ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgcc-s1 \
            libgdk-pixbuf-2.0-0 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1 \
            libasound2t64 \
            ca-certificates \
            fonts-liberation \
            libappindicator3-1 \
            xdg-utils \
            wget \
            gnupg
    
      - name: å…‹éš† yuque-exporter é¡¹ç›®
        run: |
          cd ${{ runner.temp }}
          git clone https://github.com/YoWuwuuuw/yuque-exporter.git
    
      - name: å®‰è£… yuque-exporter ä¾èµ–
        run: |
          cd ${{ runner.temp }}/yuque-exporter
          npm install
          # éªŒè¯ Puppeteer æ˜¯å¦æ­£ç¡®å®‰è£…äº† Chromium
          echo "æ£€æŸ¥ Puppeteer Chromium è·¯å¾„..."
          node -e "const puppeteer = require('puppeteer'); console.log('Puppeteer å¯æ‰§è¡Œè·¯å¾„:', puppeteer.executablePath());" || echo "âš ï¸ æ— æ³•è·å– Chromium è·¯å¾„ï¼Œå°†åœ¨è¿è¡Œæ—¶è‡ªåŠ¨ä¸‹è½½"
    
      - name: æ¢å¤ cookies.json æ–‡ä»¶
        run: |
          cd ${{ runner.temp }}/yuque-exporter
          if [ -z "${{ secrets.YUQUE_COOKIES }}" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° YUQUE_COOKIES secretï¼Œè¯·å…ˆåœ¨ GitHub Secrets ä¸­é…ç½®"
            exit 1
          fi
          echo '${{ secrets.YUQUE_COOKIES }}' > cookies.json
          echo "âœ… Cookies å·²æ¢å¤"
    
      - name: åˆ›å»º CI ä¸“ç”¨å¯åŠ¨è„šæœ¬
        run: |
          cd ${{ runner.temp }}/yuque-exporter
          cat > main-ci.js << 'EOF'
          import puppeteer from 'puppeteer';
          import fs from 'fs';
          import path from 'path';
          import { getAllBooks } from './src/toc.js';
          import { exportMarkDownFiles } from './src/export.js';

          let color = {
              byNum: (mess, fgNum) => {
                  mess = mess || '';
                  fgNum = fgNum === undefined ? 31 : fgNum;
                  return '\u001b[' + fgNum + 'm' + mess + '\u001b[39m';
              },
              black: (mess) => color.byNum(mess, 30),
              red: (mess) => color.byNum(mess, 31),
              green: (mess) => color.byNum(mess, 32),
              yellow: (mess) => color.byNum(mess, 33),
              blue: (mess) => color.byNum(mess, 34),
              magenta: (mess) => color.byNum(mess, 35),
              cyan: (mess) => color.byNum(mess, 36),
              white: (mess) => color.byNum(mess, 37)
          };

          async function run() {
              let browser;
              try {
                  // ç¡®ä¿å¯¼å‡ºè·¯å¾„å­˜åœ¨
                  const exportPath = process.env.EXPORT_PATH || path.join(process.cwd(), 'output');
                  if (!fs.existsSync(exportPath)) {
                      console.log(`åˆ›å»ºå¯¼å‡ºç›®å½•: ${exportPath}`);
                      fs.mkdirSync(exportPath, { recursive: true });
                  }
                  process.env.EXPORT_PATH = exportPath;
                  console.log(`å¯¼å‡ºè·¯å¾„: ${exportPath}`);

                  // ä½¿ç”¨ puppeteer.launch å¯åŠ¨æµè§ˆå™¨ï¼ˆCI ç¯å¢ƒï¼‰
                  // æ³¨æ„ï¼šPuppeteer ä¼šè‡ªåŠ¨ä¸‹è½½ Chromiumï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£… Chrome
                  console.log('æ­£åœ¨å¯åŠ¨ Chromium æµè§ˆå™¨...');
                  console.log('Chromium è·¯å¾„:', puppeteer.executablePath());
                  
                  browser = await puppeteer.launch({
                      headless: 'new',  // ä½¿ç”¨æ–°çš„ headless æ¨¡å¼
                      args: [
                          '--no-sandbox',
                          '--disable-setuid-sandbox',
                          '--disable-dev-shm-usage',
                          '--disable-accelerated-2d-canvas',
                          '--no-first-run',
                          '--no-zygote',
                          '--disable-gpu'
                      ]
                  });
                  console.log('âœ… Chromium æµè§ˆå™¨å¯åŠ¨æˆåŠŸ');
                  const page = await browser.newPage();

                  // ä½¿ç”¨ cookies ç™»å½•
                  const cookieFile = './cookies.json';
                  if (!fs.existsSync(cookieFile)) {
                      throw new Error('cookies.json æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿å·²é…ç½® YUQUE_COOKIES secret');
                  }
                  
                  const cookies = JSON.parse(fs.readFileSync(cookieFile));
                  const cleanCookies = cookies.map(c => ({
                      name: c.name,
                      value: c.value,
                      domain: c.domain || '.yuque.com',
                      path: c.path || '/',
                      ...(c.expires > 0 && { expires: c.expires }),
                      ...(c.httpOnly !== undefined && { httpOnly: c.httpOnly }),
                      ...(c.secure !== undefined && { secure: c.secure }),
                      ...(c.sameSite && { sameSite: c.sameSite })
                  }));
                  
                  await page.goto('https://www.yuque.com');
                  for (const cookie of cleanCookies) {
                      try {
                          await page.setCookie(cookie);
                      } catch (err) {
                          // å¿½ç•¥å•ä¸ª cookie è®¾ç½®å¤±è´¥
                      }
                  }
                  await page.goto('https://www.yuque.com/dashboard');
                  console.log(color.green("âœ… Cookies ç™»å½•æˆåŠŸ"))
                  console.log()

                  console.log("Get book stacks ...")
                  const books = await getAllBooks(page)

                  console.log("Start export all books ...")
                  await exportMarkDownFiles(page, books)

                  console.log(color.green("âœ… å¯¼å‡ºå®Œæˆï¼"))
              } catch (error) {
                  console.error(color.red("âŒ å‘ç”Ÿé”™è¯¯:"), error);
                  throw error;
              } finally {
                  if (browser) {
                      await browser.close();
                      console.log('æµè§ˆå™¨å·²å…³é—­');
                  }
              }
          };

          run();
          EOF
    
      - name: åˆ›å»ºå¯¼å‡ºç›®å½•
        run: |
          mkdir -p ${{ runner.temp }}/yuque-output
          echo "å¯¼å‡ºç›®å½•å·²åˆ›å»º: ${{ runner.temp }}/yuque-output"
    
      - name: è¿è¡Œå¯¼å‡ºè„šæœ¬
        env:
          EXPORT_PATH: ${{ runner.temp }}/yuque-output
        run: |
          cd ${{ runner.temp }}/yuque-exporter
          node main-ci.js
    
      - name: å¤åˆ¶å¯¼å‡ºçš„æ–‡ä»¶åˆ°ä»“åº“
        run: |
          rsync -av --exclude='.git' --exclude='.github' ${{ runner.temp }}/yuque-output/ ${{ github.workspace }}/
    
      - name: ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "âœ… æ—¶é—´æˆ³: $TIMESTAMP"
    
      - name: åˆ›å»º Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "è‡ªåŠ¨åŒæ­¥è¯­é›€ç¬”è®° - ${{ steps.timestamp.outputs.timestamp }}"
          title: "åŒæ­¥ç¬”è®° ${{ steps.timestamp.outputs.timestamp }}"
          body: |
            ğŸ¤– è‡ªåŠ¨åŒæ­¥è¯­é›€ç¬”è®°
            
            - åŒæ­¥æ—¶é—´: ${{ steps.timestamp.outputs.timestamp }}
            - è¿è¡Œæ¬¡æ•°: #${{ github.run_number }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            
            > è¯·æ£€æŸ¥æ›´æ”¹ååˆå¹¶æ­¤ PR
          branch: sync-yuque-${{ steps.timestamp.outputs.timestamp }}
          delete-branch: true

